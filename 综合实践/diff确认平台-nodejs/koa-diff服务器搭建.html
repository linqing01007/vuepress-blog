<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 林晴的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="林晴的个人博客">
    <meta name="author" content="林晴">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.a53365af.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.de1052c8.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.b6e7c728.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/35.e45b5c38.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.4d993587.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.3de92a36.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.33c6a707.js"><link rel="prefetch" href="/vuepress-blog/assets/js/13.e9635f11.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.5004bcea.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.9d19c796.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.07462734.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.05758c46.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.4bd7405d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.0bf5472d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.67738b8b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.f11605a0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.481d5f80.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.9982313b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.1ad2e968.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.2e0d7ea4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.1ad50f6b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.ba40573a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.d4e58e21.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.16a7e93e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.1357c17c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.fdc40ded.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.1ebbbac2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.682d64b4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.cc500df2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.bb466845.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.434c442c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.94790aea.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.118cd991.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.af93e315.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.dec834b8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.54f18c34.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.e34cacb3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.f8822c70.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.5af1e7c0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.57329301.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.71350c95.js"><link rel="prefetch" href="/vuepress-blog/assets/js/46.5b3dfc2f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/47.806135d3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/48.01f8376e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/49.30278d9c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.6f94c648.js"><link rel="prefetch" href="/vuepress-blog/assets/js/50.588062e7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/51.1fcc6dd2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/52.ebe7a612.js"><link rel="prefetch" href="/vuepress-blog/assets/js/53.338c2baf.js"><link rel="prefetch" href="/vuepress-blog/assets/js/54.637984b1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/55.b94dbbe0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/56.05880194.js"><link rel="prefetch" href="/vuepress-blog/assets/js/57.ff53340c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/58.bd4f6e1a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.600bc016.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.d84fc58f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.90f7891a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.b29a76b1.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.a53365af.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">林晴的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue3</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>dom</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试工程师</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>综合实践</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>diff确认平台-nodejs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/diff确认页面.html" class="sidebar-link">diff确认页面</a></li><li><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/koa-diff服务器搭建.html" class="active sidebar-link">koa-diff服务器搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/koa-diff服务器搭建.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/koa-diff服务器搭建.html#package-json" class="sidebar-link">package.json</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/koa-diff服务器搭建.html#基本配置" class="sidebar-link">基本配置</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/koa-diff服务器搭建.html#简单的登陆功能" class="sidebar-link">简单的登陆功能</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/koa-diff服务器搭建.html#diff确认业务逻辑" class="sidebar-link">diff确认业务逻辑</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/koa-diff服务器搭建.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/svnhooks.html" class="sidebar-link">svnhooks</a></li><li><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/简介.html" class="sidebar-link">简介</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>diff确认平台-python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>utils</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>大前端2021</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>小米商城</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>部署</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>这里是使用了nodejs的服务器框架koa2+mongodb来搭建diff确认的服务器。</p> <h2 id="package-json"><a href="#package-json" class="header-anchor">#</a> package.json</h2> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@koa/router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.1.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;async&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.2.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;axios&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.26.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;body-parser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.19.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;cron&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;iconv-lite&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.6.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;jsonwebtoken&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.5.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.13.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-body&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.2.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-bodyparser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.3.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-cors&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.0.16&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-log4&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.3.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-static&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.1.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa2-cors&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mongoose&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.0.14&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;shelljs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.8.5&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start-dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon app.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node app.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;diff-dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon diffApp.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;diff&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node diffApp.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.15&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="基本配置"><a href="#基本配置" class="header-anchor">#</a> 基本配置</h2> <p>app.js</p> <h4 id="跨域"><a href="#跨域" class="header-anchor">#</a> 跨域</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">'koa'</span>
<span class="token keyword">import</span> KoaCors <span class="token keyword">from</span> <span class="token string">'koa2-cors'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">KoaCors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="post请求解析"><a href="#post请求解析" class="header-anchor">#</a> post请求解析</h4> <p>需要指定可接受的最大请求体，不然有些diff比较大可能会上传失败，默认好像只有1mb</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> bodyParser <span class="token keyword">from</span> <span class="token string">'koa-body'</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    multipart<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    formLimit<span class="token operator">:</span> <span class="token string">&quot;100mb&quot;</span><span class="token punctuation">,</span>
    jsonLimit<span class="token operator">:</span> <span class="token string">&quot;100mb&quot;</span><span class="token punctuation">,</span>
    textLimit<span class="token operator">:</span> <span class="token string">&quot;100mb&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="mongo数据库连接"><a href="#mongo数据库连接" class="header-anchor">#</a> mongo数据库连接</h4> <p>db/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">'mongoose'</span>

<span class="token keyword">function</span> <span class="token function">dateFormat</span><span class="token punctuation">(</span><span class="token parameter">fmt<span class="token punctuation">,</span> date</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">const</span> opt <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;Y+&quot;</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// 年</span>
        <span class="token string">&quot;m+&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// 月</span>
        <span class="token string">&quot;d+&quot;</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">// 日</span>
        <span class="token string">&quot;H+&quot;</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// 时</span>
        <span class="token string">&quot;M+&quot;</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// 分</span>
        <span class="token string">&quot;S+&quot;</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment">// 秒</span>
        <span class="token comment">// 有其他格式化字符需求可以继续添加，必须转化成字符串</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">in</span> opt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fmt <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>opt<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>opt<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span>ret<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">rTime</span><span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> json_date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">dateFormat</span><span class="token punctuation">(</span><span class="token string">'YYYY-mm-dd HH:MM:SS'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>json_date<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/diff'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mongoose connect error: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mongoose connect suc'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Schema <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>Schema

<span class="token keyword">const</span> AuthorSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> DiffDataSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    version<span class="token operator">:</span> String<span class="token punctuation">,</span>
    submitter<span class="token operator">:</span> String<span class="token punctuation">,</span>
    branch<span class="token operator">:</span> String<span class="token punctuation">,</span>
    time<span class="token operator">:</span> Date<span class="token punctuation">,</span>
    comment<span class="token operator">:</span> String<span class="token punctuation">,</span>
    diff<span class="token operator">:</span> Array<span class="token punctuation">,</span>
    files<span class="token operator">:</span> String<span class="token punctuation">,</span>
    confirmer<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> CommandSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    code<span class="token operator">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 自定义转换为json时的格式</span>
DiffDataSchema<span class="token punctuation">.</span>options<span class="token punctuation">.</span>toObject <span class="token operator">=</span> DiffDataSchema<span class="token punctuation">.</span>options<span class="token punctuation">.</span>toJSON <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">transform</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret<span class="token punctuation">.</span>time <span class="token operator">=</span> <span class="token function">rTime</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>time<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Author <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Author'</span><span class="token punctuation">,</span> AuthorSchema<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Diff <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'DiffData'</span><span class="token punctuation">,</span> DiffDataSchema<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Command <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Code'</span><span class="token punctuation">,</span> CommandSchema<span class="token punctuation">)</span>

</code></pre></div><p>controller/Diff.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Author<span class="token punctuation">,</span> Diff <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../db/index.js&quot;</span>
<span class="token keyword">import</span> <span class="token keyword">async</span> <span class="token keyword">from</span> <span class="token string">'async'</span>

<span class="token keyword">class</span> <span class="token class-name">AuthorController</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">create</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> Author<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">find</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> Author<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DiffController</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">create</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log(&quot;diffcontroller create: &quot;, args)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">findByAuthor</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">findByLog</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">find</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'time'</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">pageFind</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// console.log('&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;find page: ,', page, pageSize)</span>
                <span class="token comment">// pageSize = 10</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'time'</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">pageQuery</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> queryParams</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize
        <span class="token keyword">const</span> $page <span class="token operator">=</span> <span class="token punctuation">{</span>
            pageNumber<span class="token operator">:</span> page
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> <span class="token function-variable function">count</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> <span class="token function-variable function">records</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">records</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter">conditions<span class="token punctuation">,</span> update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> DiffControllerInstance <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">DiffController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> AuthorControllerInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> DiffControllerInstance<span class="token punctuation">,</span> AuthorControllerInstance <span class="token punctuation">}</span>
</code></pre></div><h4 id="日志"><a href="#日志" class="header-anchor">#</a> 日志</h4> <p>app.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> loggerMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middleware/categories.js'</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>loggerMiddleware<span class="token punctuation">)</span>
</code></pre></div><p>middleware/categories.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> log4js <span class="token keyword">from</span> <span class="token string">'koa-log4'</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  appenders<span class="token operator">:</span> <span class="token punctuation">{</span>
    console<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'console'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    success<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
      maxLogSize<span class="token operator">:</span> <span class="token number">5</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 超过多少(byte)就切割</span>
      backups<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 保留旧日志数量(default: 5)</span>
      <span class="token comment">// compress: true, // 缩成.gz格式</span>
      filename<span class="token operator">:</span> <span class="token string">'logs/info.log'</span><span class="token punctuation">,</span>
      pattern<span class="token operator">:</span> <span class="token string">'-yyyy-MM-dd-hh-mm'</span><span class="token punctuation">,</span>
      keepFileExt<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 切割的日志保留文件扩展名，false(默认):生成类似default.log.1文件;true:生成类似default.1.log</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token string">'logs/errors.log'</span><span class="token punctuation">,</span>
      <span class="token comment">// alwaysIncludePattern: true, // 代表在最新的一个日志文件里追加日志(默认是在errors.log文件写入内容)</span>
      daysToKeep<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 大于0则会删除x天之前的日志</span>
      pattern<span class="token operator">:</span> <span class="token string">'-yyyy-MM-dd'</span><span class="token punctuation">,</span> <span class="token comment">// yyyy-MM-dd-hh-mm=&gt;每分钟切割一次 yyyy-mm-dd-hh =&gt;每小时</span>
      keepFileExt<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  categories<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      appenders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'console'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      level<span class="token operator">:</span> <span class="token string">'all'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    success<span class="token operator">:</span> <span class="token punctuation">{</span>
      appenders<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'success'</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      level<span class="token operator">:</span> <span class="token string">'all'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    errors<span class="token operator">:</span> <span class="token punctuation">{</span>
      appenders<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'errors'</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      level<span class="token operator">:</span> <span class="token string">'error'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> loggerMiddleware <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">koaLogger</span><span class="token punctuation">(</span>log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> level<span class="token operator">:</span> <span class="token string">'info'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> errLogger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'errors'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> infoLogger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="简单的登陆功能"><a href="#简单的登陆功能" class="header-anchor">#</a> 简单的登陆功能</h2> <p>因为diff确认时需要知道确认的是谁，所以要有一个登陆功能，这里是做了一个很简单的jwt验证的登陆功能。</p> <h4 id="mongo"><a href="#mongo" class="header-anchor">#</a> mongo</h4> <h4 id="登陆"><a href="#登陆" class="header-anchor">#</a> 登陆</h4> <p>api/login.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AuthorControllerInstance <span class="token keyword">as</span> AuthorController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../controller/Diff.js'</span>
<span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span>

<span class="token keyword">function</span> <span class="token function">createToken</span> <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> secret <span class="token operator">=</span> <span class="token string">'app_linqing'</span><span class="token punctuation">,</span> expiresIn <span class="token operator">=</span> <span class="token string">'-1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token punctuation">{</span> expiresIn <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">login</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> AuthorController<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> user<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        user <span class="token operator">=</span> <span class="token keyword">await</span> AuthorController<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        user <span class="token operator">=</span> user<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> user<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        token<span class="token punctuation">,</span>
        name<span class="token operator">:</span> user<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> login
</code></pre></div><h4 id="授权认证"><a href="#授权认证" class="header-anchor">#</a> 授权认证</h4> <p>如果没有登陆时发起确认请求则返回401，前端收到401则自动跳到登陆页面，如果已经登陆了，前端将token保存，并在后续请求的header中加上authorization，这样只需一次登陆即可不用再次登陆
这里的token是永久有效的，这样就不用做刷新逻辑。
middleware/auth.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span>
<span class="token comment">// 需要登陆的接口</span>
<span class="token keyword">const</span> requirePaths <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">]</span>
  
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// const pathObj = path.parse(ctx.request.url)</span>
    <span class="token keyword">const</span> require <span class="token operator">=</span> requirePaths<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">pattern</span> <span class="token operator">=&gt;</span> pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>require<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> authorization <span class="token operator">=</span> ctx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>authorization
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^Bearer</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> authorization<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">const</span> payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>exp <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">&gt;=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
                code<span class="token operator">:</span> <span class="token number">401</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>state <span class="token operator">=</span> payload
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;not authorization&quot;</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">401</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>app.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> authorization <span class="token keyword">from</span> <span class="token string">'middleware/auth.js'</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span>
</code></pre></div><h2 id="diff确认业务逻辑"><a href="#diff确认业务逻辑" class="header-anchor">#</a> diff确认业务逻辑</h2> <p>api/diff.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> includeSuffix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">function</span> <span class="token function">diffFilter</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> diffData <span class="token keyword">of</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> newDiff <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">let</span> diff <span class="token operator">=</span> diffData<span class="token punctuation">.</span>diff
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> diffObj <span class="token keyword">of</span> diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>includeSuffix<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">suffix</span> <span class="token operator">=&gt;</span> diffObj<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newDiff<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>diffObj<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        diffData<span class="token punctuation">.</span>diff <span class="token operator">=</span> newDiff
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newDiff<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>diffData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">calWeekTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取每周四早上6点时间戳，</span>
    <span class="token comment">// 如果已经过了本周四六点，则返回本周四六点的时间戳</span>
    <span class="token comment">// 如果没有，则返回上周四六点时间戳</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> day <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">const</span> refreshWeek <span class="token operator">=</span> <span class="token number">4</span>
    current<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> current<span class="token punctuation">.</span><span class="token function">getDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> refreshWeek<span class="token punctuation">)</span>
    <span class="token keyword">const</span> refreshTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span><span class="token function">toDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span>

    <span class="token keyword">return</span> currentTime <span class="token operator">&gt;=</span> refreshTime <span class="token operator">?</span> refreshTime <span class="token operator">:</span> refreshTime <span class="token operator">-</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">calDiffData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取每周版本未确认diff</span>
    <span class="token keyword">let</span> weekTime <span class="token operator">=</span> <span class="token function">calWeekTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> startTime <span class="token operator">=</span> weekTime
    <span class="token keyword">const</span> queryRes <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> time<span class="token operator">:</span> <span class="token punctuation">{</span> $gte<span class="token operator">:</span> startTime <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">diffFilter</span><span class="token punctuation">(</span>queryRes<span class="token punctuation">)</span>
    res <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>confirmer <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">searchDiffData</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里只列出了部分搜索关键字</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query
    <span class="token keyword">const</span> queryParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// let res = []</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'startTime'</span> <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'endTime'</span> <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            queryParams<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>$gte<span class="token operator">:</span> params<span class="token punctuation">[</span><span class="token string">'startTime'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> $lte<span class="token operator">:</span> params<span class="token punctuation">[</span><span class="token string">'endTime'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            queryParams<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>$gte<span class="token operator">:</span> params<span class="token punctuation">[</span><span class="token string">'startTime'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token function">calWeekTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        queryParams<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span>  <span class="token punctuation">{</span> $gte<span class="token operator">:</span> startTime <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'comment'</span> <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">'comment'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span>
        queryParams<span class="token punctuation">[</span><span class="token string">'comment'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>$regex<span class="token operator">:</span> reg<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'files'</span> <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span>
        queryParams<span class="token punctuation">[</span><span class="token string">'files'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>$regex<span class="token operator">:</span> reg<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'confirm'</span> <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">'confirm'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'true'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            queryParams<span class="token punctuation">[</span><span class="token string">'confirmer'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>$ne<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            queryParams<span class="token punctuation">[</span><span class="token string">'confirmer'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>$eq<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span>
    res <span class="token operator">=</span> <span class="token function">diffFilter</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> res
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleInfos</span> <span class="token punctuation">(</span><span class="token parameter">infos</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    @return {
        time,
        comment,
        versiont,
        branch,
        diff: [{
            name,
            confirmer,
            content
        }],
        confirmer,
        submitter,
        files
    }
    */</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> time<span class="token punctuation">,</span> diff<span class="token punctuation">,</span> comment<span class="token punctuation">,</span> submitter<span class="token punctuation">,</span> version <span class="token punctuation">}</span> <span class="token operator">=</span> infos
    comment <span class="token operator">=</span> comment<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    submitter <span class="token operator">=</span> submitter<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> branch <span class="token operator">=</span> <span class="token string">''</span>
    diff <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span>
    <span class="token keyword">const</span> newDiff <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> filename <span class="token keyword">in</span> diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        branch <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        newDiff<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token operator">:</span> filename<span class="token punctuation">,</span>
            confirmer<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            content<span class="token operator">:</span> diff<span class="token punctuation">[</span>filename<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span> time<span class="token punctuation">,</span> comment<span class="token punctuation">,</span> version<span class="token punctuation">,</span> branch<span class="token punctuation">,</span> diff<span class="token operator">:</span> newDiff <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> <span class="token string">''</span>
    res<span class="token punctuation">.</span>submitter <span class="token operator">=</span> submitter
    <span class="token comment">// files字段主要用于搜索</span>
    res<span class="token punctuation">.</span>files <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">postDiff</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> infos <span class="token operator">=</span> <span class="token function">handleInfos</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        infoLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'post diff: '</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span> infos<span class="token punctuation">)</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>infos<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'handle info error: '</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'suc'</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">confirmOneCommit</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对一条提交的确认规则：</span>
    <span class="token comment">// 1. 里面所有未确认的文件都会由该作者确认</span>
    <span class="token comment">// 2. 如果该提交的所有文件都已被其他人确认，则会覆盖所有文件的确认者</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state
    <span class="token keyword">let</span> diffs <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diffs<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">404</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    diffs <span class="token operator">=</span> <span class="token function">diffFilter</span><span class="token punctuation">(</span>diffs<span class="token punctuation">)</span>
    <span class="token keyword">let</span> diff <span class="token operator">=</span> diffs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    diff<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> name
    <span class="token keyword">let</span> allConfirmed <span class="token operator">=</span> diff<span class="token punctuation">.</span>diff<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>confirmer <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> diffObj <span class="token keyword">of</span> diff<span class="token punctuation">.</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allConfirmed <span class="token operator">&amp;&amp;</span> diffObj<span class="token punctuation">.</span>confirmer<span class="token punctuation">)</span> <span class="token keyword">continue</span>
        diffObj<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> name
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> diff<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> diff
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">101</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">cancelConfirmOneCommit</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对一条提交的取消规则：</span>
    <span class="token comment">// 1. 该提交包含文件中所有该作者确认的都会被取消</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">let</span> diffs <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diffs<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">404</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    diffs <span class="token operator">=</span> <span class="token function">diffFilter</span><span class="token punctuation">(</span>diffs<span class="token punctuation">)</span>
    <span class="token keyword">let</span> diff <span class="token operator">=</span> diffs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    diff<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> diffObj <span class="token keyword">of</span> diff<span class="token punctuation">.</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>diffObj<span class="token punctuation">.</span>confirmer <span class="token operator">!==</span> name<span class="token punctuation">)</span> <span class="token keyword">continue</span>
        diffObj<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> res  <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> diff<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> diff
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">101</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">confirmOneFile</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对某个文件的确认规则</span>
    <span class="token comment">// 1. 如果是该提交的最后一个未确认文件，则会设置为该条提交的确认者</span>
    <span class="token comment">// 2. 如果该文件已有确认者，直接覆盖</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state
    <span class="token keyword">let</span> diffs <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diffs<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">404</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    diffs <span class="token operator">=</span> <span class="token function">diffFilter</span><span class="token punctuation">(</span>diffs<span class="token punctuation">)</span>
    <span class="token keyword">let</span> diff <span class="token operator">=</span> diffs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> diffObj <span class="token keyword">of</span> diff<span class="token punctuation">.</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>diffObj<span class="token punctuation">.</span>name <span class="token operator">==</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            diffObj<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> name
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> allConfirmed <span class="token operator">=</span> diff<span class="token punctuation">.</span>diff<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>confirmer <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span>
    diff<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> allConfirmed <span class="token operator">?</span> name <span class="token operator">:</span> <span class="token string">''</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> diff<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> diff
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">101</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">cancelConfirmOneFile</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对单个文件的取消确认规则</span>
    <span class="token comment">// 1. 如果该提交已被确认，则将该提交的确认者设置为空</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state
    <span class="token keyword">let</span> diffs <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diffs<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">404</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    diffs <span class="token operator">=</span> <span class="token function">diffFilter</span><span class="token punctuation">(</span>diffs<span class="token punctuation">)</span>
    <span class="token keyword">let</span> diff <span class="token operator">=</span> diffs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    diff<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> diffObj <span class="token keyword">of</span> diff<span class="token punctuation">.</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>diffObj<span class="token punctuation">.</span>name <span class="token operator">==</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            diffObj<span class="token punctuation">.</span>confirmer <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> diff<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> diff
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            code<span class="token operator">:</span> <span class="token number">101</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">pageFind</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 分页查询</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> page<span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> DiffControllerInstance<span class="token punctuation">.</span><span class="token function">pageFind</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'page find'</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getSubmitters'</span><span class="token punctuation">,</span> getSubmitters<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getData'</span><span class="token punctuation">,</span> getDiffData<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/postData'</span><span class="token punctuation">,</span> postDiff<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">,</span> searchDiffData<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/confirmOneCommit'</span><span class="token punctuation">,</span> confirmOneCommit<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/cancelConfirmOneCommit'</span><span class="token punctuation">,</span> cancelConfirmOneCommit<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/confirmOneFile'</span><span class="token punctuation">,</span> confirmOneFile<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/cancelConfirmOneFile'</span><span class="token punctuation">,</span> cancelConfirmOneFile<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/pagefind'</span><span class="token punctuation">,</span> pageFind<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> login<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router

</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>至此，服务器大部分逻辑基本完成。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-blog/综合实践/diff确认平台-nodejs/diff确认页面.html" class="prev">
        diff确认页面
      </a></span> <span class="next"><a href="/vuepress-blog/综合实践/diff确认平台-nodejs/svnhooks.html">
        svnhooks
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-blog/assets/js/app.de1052c8.js" defer></script><script src="/vuepress-blog/assets/js/2.b6e7c728.js" defer></script><script src="/vuepress-blog/assets/js/35.e45b5c38.js" defer></script>
  </body>
</html>
