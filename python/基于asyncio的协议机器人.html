<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>解析proto文件 | 林晴的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="林晴的个人博客">
    <meta name="author" content="林晴">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.a53365af.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.c8cd4592.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.b6e7c728.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/17.05758c46.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.ed486a11.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.bc20b250.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.50b067f3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/13.fe79309d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.8a45440a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.0ebc7b6d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.200cef6d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.4bd7405d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.0bf5472d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.7f86b04b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.6f21d054.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.481d5f80.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.49f5faf5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.ada76972.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.229c3b7e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.49bebd3e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.ba40573a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.3ac9a943.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.1f480e45.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.1357c17c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.fdc40ded.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.7f92f82f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.9fe6c810.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.dd9504e9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.187eae7e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.7489dd8e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.02b7fd9b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.0a4212a8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.1d1838b3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.af93e315.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.dec834b8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.d0fb90d0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.3d2b5251.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.03c20d58.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.bf0f451c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.fda51d3e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.a5b48206.js"><link rel="prefetch" href="/vuepress-blog/assets/js/46.e2bc5688.js"><link rel="prefetch" href="/vuepress-blog/assets/js/47.806135d3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/48.f0118031.js"><link rel="prefetch" href="/vuepress-blog/assets/js/49.e5746537.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.6f94c648.js"><link rel="prefetch" href="/vuepress-blog/assets/js/50.f336bf42.js"><link rel="prefetch" href="/vuepress-blog/assets/js/51.14a7e0c6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/52.586f2be0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/53.b0501a4b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/54.a82a0c2a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/55.b94dbbe0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/56.05880194.js"><link rel="prefetch" href="/vuepress-blog/assets/js/57.daf66b43.js"><link rel="prefetch" href="/vuepress-blog/assets/js/58.c51be92a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.600bc016.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.d84fc58f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.9c62b16e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.e8a81e47.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.a53365af.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">林晴的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue3</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>dom</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>python</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/python/flask框架模板.html" class="sidebar-link">flask框架模板</a></li><li><a href="/vuepress-blog/python/subprocess.html" class="sidebar-link">subprocess</a></li><li><a href="/vuepress-blog/python/基于asyncio的协议机器人.html" class="active sidebar-link">基于asyncio的协议机器人</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog/python/基于asyncio的协议机器人.html#解析proto文件" class="sidebar-link">解析proto文件</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/python/基于asyncio的协议机器人.html#robotbase" class="sidebar-link">RobotBase</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/python/基于asyncio的协议机器人.html#局限" class="sidebar-link">局限</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>测试工程师</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>综合实践</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>部署</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="解析proto文件"><a href="#解析proto文件" class="header-anchor">#</a> 解析proto文件</h2> <ol><li>安装protoc编译器： https://github.com/protocolbuffers/protobuf/releases
选择与项目对应的版本下载安装，安装成功后，在命令行中执行：<code>protoc --version</code> 验证安装成功</li> <li>使用protoc编译proto文件：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>protoc -I<span class="token operator">=</span>input_path --python_out<span class="token operator">=</span>out_put_path proto_file_name
</code></pre></div><p>其中<code>input_path</code>为proto文件所在目录，<code>out_put_path</code>为生成python文件存放目录，<code>proto_file_name</code>为proto文件名
3. 批量编译</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> subdir<span class="token punctuation">,</span> subfile<span class="token punctuation">)</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>src_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> subfile<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.proto'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">continue</span>
        subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'protoc'</span><span class="token punctuation">,</span> <span class="token string">'-I=%s'</span> <span class="token operator">%</span> src_path<span class="token punctuation">,</span> <span class="token string">'--python_out=%s'</span> <span class="token operator">%</span> dest_path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> subfile<span class="token punctuation">)</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>dest_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 重新修改Import 路径</span>
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> subfile<span class="token punctuation">:</span>
        <span class="token comment"># print('compile_proto: ', file)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.py'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">continue</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dest_path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token keyword">as</span> f<span class="token punctuation">:</span>
            lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> index<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'import'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">continue</span>
                <span class="token comment"># print('compile line: ', line)</span>
                lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'from </span><span class="token interpolation"><span class="token punctuation">{</span>project<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.proto '</span></span> <span class="token operator">+</span> line
            f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span>lines<span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>truncate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ol start="4"><li>序列化和反序列化</li></ol> <div class="language-protobuf extra-class"><pre class="language-protobuf"><code><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">package</span> client_proto<span class="token punctuation">;</span>
<span class="token keyword">option</span> go_package <span class="token operator">=</span> <span class="token string">&quot;slg_server/common/proto/pb/client_pb/client_proto&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;shared.proto&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;replay.proto&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;compute.proto&quot;</span><span class="token punctuation">;</span>


<span class="token comment">//MsgMeta MsgId 1000002</span>
<span class="token comment">//MsgMeta Description 增加道具</span>
<span class="token keyword">message</span> <span class="token class-name">DebugAddPropReq</span> <span class="token punctuation">{</span>
    <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">int64</span><span class="token punctuation">&gt;</span></span> prop <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">message</span> <span class="token class-name">DebugAddPropRsp</span> <span class="token punctuation">{</span>
    <span class="token builtin">bool</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> debug_pb2 <span class="token keyword">import</span> DebugAddPropReq<span class="token punctuation">,</span> DebugAddPropRsp 
<span class="token comment"># 序列化</span>
req <span class="token operator">=</span> DebugAddPropReq<span class="token punctuation">(</span>prop<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">45901001</span><span class="token punctuation">:</span> <span class="token number">5000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">buffer</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 反序列化</span>
rsp <span class="token operator">=</span> DebugAddPropReq<span class="token punctuation">(</span><span class="token punctuation">)</span>
rsp<span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>
</code></pre></div><ol start="5"><li>应用</li></ol> <div class="language-python extra-class"><pre class="language-python"><code>dest_path <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment"># 存放编译后的python文件的目录</span>
proto_module <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>dest_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m_name <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    m <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>m_name<span class="token punctuation">)</span>
    methods <span class="token operator">=</span> <span class="token punctuation">[</span>method <span class="token keyword">for</span> method <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> method <span class="token keyword">in</span> methods<span class="token punctuation">:</span>
        proto_module<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> m

map_file_path <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment"># proto文件映射文件</span>
proto_map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>map_file_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">:</span> <span class="token keyword">continue</span>
        p <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>
                proto_map<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token string">'req'</span><span class="token punctuation">:</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">'rsp'</span><span class="token punctuation">:</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                proto_map<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token string">'rsp'</span><span class="token punctuation">:</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'proto map bad line: '</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">proto_buf_encode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_name<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> proto_module<span class="token punctuation">.</span>get<span class="token punctuation">(</span>proto_name<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token comment"># logger.info('proto_buf_encode: m= ', proto_no, m)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> m<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'proto encode: proto_module no not found'</span><span class="token punctuation">,</span> proto_name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    method <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> proto_name<span class="token punctuation">)</span>
    <span class="token builtin">buffer</span> <span class="token operator">=</span> method<span class="token punctuation">(</span><span class="token operator">**</span>data<span class="token punctuation">)</span>
    <span class="token comment"># logger.info('encode buffer: ', proto_name, buffer, buffer.SerializeToString())</span>
    <span class="token keyword">return</span> <span class="token builtin">buffer</span><span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">proto_buf_decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_name<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> proto_module<span class="token punctuation">.</span>get<span class="token punctuation">(</span>proto_name<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> m<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    method <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> proto_name<span class="token punctuation">)</span>
    <span class="token builtin">buffer</span> <span class="token operator">=</span> method<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">buffer</span><span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">buffer</span>
</code></pre></div><h2 id="robotbase"><a href="#robotbase" class="header-anchor">#</a> RobotBase</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> random
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> ssl
<span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> traceback
<span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> loguru <span class="token keyword">import</span> logger
<span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> ClientSession<span class="token punctuation">,</span> TCPConnector

<span class="token comment"># from dm03.task_manager import TaskManager</span>

<span class="token keyword">from</span> proto_gen_helper <span class="token keyword">import</span> Opcode<span class="token punctuation">,</span> PACKET_VER<span class="token punctuation">,</span> PACKET_HEAD_SIZE<span class="token punctuation">,</span> HEART_BEAT_INTERVAL<span class="token punctuation">,</span> ProtoGenHelper

<span class="token keyword">class</span> <span class="token class-name">RobotBase</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> device_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> hostname<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> svr_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> need_destroy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>hostname <span class="token operator">=</span> hostname
        self<span class="token punctuation">.</span>writer <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>device_id <span class="token operator">=</span> device_id
        self<span class="token punctuation">.</span>svr_id <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>svr_id <span class="token keyword">or</span> <span class="token number">101</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tasks <span class="token operator">=</span> tasks
        self<span class="token punctuation">.</span>last_ping_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>proto_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>proto_data_queues <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>proto_listeners <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>need_send <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># self.wait_receive = {}</span>
        self<span class="token punctuation">.</span>proto_queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>gate_svr <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>last_ack <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>need_destroy <span class="token operator">=</span> need_destroy
        
    
    <span class="token keyword">def</span> <span class="token function">loop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>self<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'robot </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>device_id<span class="token punctuation">}</span></span><span class="token string"> run start'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>fast_login<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>connect_gate_svr<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>do_coroutine_task<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_fast_login_url</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fast_login</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
        self<span class="token punctuation">.</span>gate_svr<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span>
        self<span class="token punctuation">.</span>accessToken <span class="token operator">=</span> <span class="token string">''</span>
        
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect_gate_svr</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>create_default_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>gate_svr<span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>

        context<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">False</span>
        context<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_NONE
        connector <span class="token operator">=</span> TCPConnector<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span>context<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> ClientSession<span class="token punctuation">(</span>connector<span class="token operator">=</span>connector<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
                reader<span class="token punctuation">,</span> writer <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>open_connection<span class="token punctuation">(</span>self<span class="token punctuation">.</span>gate_svr<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port<span class="token punctuation">,</span> ssl<span class="token operator">=</span>context<span class="token punctuation">,</span> limit<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">return</span>

        self<span class="token punctuation">.</span>reader <span class="token operator">=</span> reader
        self<span class="token punctuation">.</span>writer <span class="token operator">=</span> writer
        protocol <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>StreamReaderProtocol<span class="token punctuation">(</span>self<span class="token punctuation">.</span>reader<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>_transport <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>_transport<span class="token punctuation">.</span>set_protocol<span class="token punctuation">(</span>protocol<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'transport is None'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>heartbeat_countdown <span class="token operator">=</span> HEART_BEAT_INTERVAL

        
        <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>drain<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">True</span>

        
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do_coroutine_task</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># await asyncio.sleep(random.randint(1, 3))</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'robot </span><span class="token interpolation"><span class="token punctuation">{</span> self<span class="token punctuation">.</span>device_id <span class="token punctuation">}</span></span><span class="token string">do_coroutine_task start'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>coroutine_tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
            asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ping<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>handle_proto<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>do_task<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>coroutine_tasks<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'robot </span><span class="token interpolation"><span class="token punctuation">{</span> self<span class="token punctuation">.</span>device_id <span class="token punctuation">}</span></span><span class="token string"> do_coroutine_task exception: </span><span class="token interpolation"><span class="token punctuation">{</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>need_send<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    buff <span class="token operator">=</span> self<span class="token punctuation">.</span>need_send<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buff<span class="token punctuation">)</span>
                    <span class="token keyword">await</span> self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>drain<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> ConnectionResetError<span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'writer exception: </span><span class="token interpolation"><span class="token punctuation">{</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">send_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> data<span class="token punctuation">,</span> opcode<span class="token operator">=</span>Opcode<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token builtin">buffer</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>proto_buf_encode_by_no<span class="token punctuation">(</span>proto_no<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            package_buffer <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>encode_package<span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">buffer</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>need_send<span class="token punctuation">.</span>append<span class="token punctuation">(</span>package_buffer<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'robot send_data proto </span><span class="token interpolation"><span class="token punctuation">{</span>proto_no<span class="token punctuation">}</span></span><span class="token string"> error: </span><span class="token interpolation"><span class="token punctuation">{</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_receive</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> data<span class="token punctuation">,</span> opcode<span class="token operator">=</span>Opcode<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        queue <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">[</span>proto_no<span class="token punctuation">]</span> <span class="token operator">=</span> queue

            <span class="token builtin">buffer</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>proto_buf_encode_by_no<span class="token punctuation">(</span>proto_no<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            package_buffer <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>encode_package<span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">buffer</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>need_send<span class="token punctuation">.</span>append<span class="token punctuation">(</span>package_buffer<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'robot send proto </span><span class="token interpolation"><span class="token punctuation">{</span>proto_no<span class="token punctuation">}</span></span><span class="token string"> error: </span><span class="token interpolation"><span class="token punctuation">{</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        
        data <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">del</span> self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">[</span>proto_no<span class="token punctuation">]</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">wait_for_push</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> max_times<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">[</span>proto_no<span class="token punctuation">]</span> <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
            <span class="token keyword">if</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time <span class="token operator">&gt;=</span> max_times<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">if</span> proto_no <span class="token keyword">in</span> self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">:</span>
                <span class="token comment"># logger.info(f&quot;send_receive end, proto_no={proto_no}&quot;)</span>
                data <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>proto_no<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># self.wait_receive[int(proto_no)] = False</span>
                <span class="token keyword">del</span> self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>proto_no<span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token keyword">return</span> data
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">add_push_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_no<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>wait_receive<span class="token punctuation">[</span>proto_no<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
        
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_proto</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>proto_data<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                proto_no<span class="token punctuation">,</span> data <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment"># logger.info(f&quot;robot {self.device_id} handle proto start {proto_no}, {len(self.proto_data)}&quot;)</span>
                <span class="token keyword">if</span> proto_no <span class="token keyword">in</span> self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">:</span>
                    <span class="token keyword">await</span> self<span class="token punctuation">.</span>proto_queues<span class="token punctuation">[</span>proto_no<span class="token punctuation">]</span><span class="token punctuation">.</span>put<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">await</span> self<span class="token punctuation">.</span>on_proto_handler<span class="token punctuation">(</span>proto_no<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># logger.info(f&quot;handle proto end &quot;)</span>
                <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">on_proto_handler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> proto_no <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>proto_listeners<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        l <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_listeners<span class="token punctuation">.</span>get<span class="token punctuation">(</span>proto_no<span class="token punctuation">)</span>
        <span class="token keyword">if</span> asyncio<span class="token punctuation">.</span>iscoroutinefunction<span class="token punctuation">(</span>l<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'callback'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> l<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'obj'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> l<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'callback'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> l<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'callback'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> l<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'obj'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                l<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'callback'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                l<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'callback'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add_proto_listener</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> obj<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>proto_listeners<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>proto_listeners <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'proto_no </span><span class="token interpolation"><span class="token punctuation">{</span>proto_no<span class="token punctuation">}</span></span><span class="token string"> callback is not callable'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>proto_listeners<span class="token punctuation">[</span>proto_no<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'callback'</span><span class="token punctuation">:</span> callback<span class="token punctuation">,</span>
            <span class="token string">'obj'</span><span class="token punctuation">:</span> obj
        <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment"># logger.info(&quot;update receive start&quot;)</span>
                head <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                body <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                byte_needed <span class="token operator">=</span> PACKET_HEAD_SIZE
                
                <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">&lt;</span> byte_needed <span class="token keyword">and</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
                    d <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span>byte_needed <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> d<span class="token punctuation">:</span> <span class="token keyword">break</span>
                    head <span class="token operator">+=</span> d
                
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">==</span> byte_needed<span class="token punctuation">:</span>
                    opcode<span class="token punctuation">,</span> option<span class="token punctuation">,</span> data_size <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>decode_packet_head<span class="token punctuation">(</span>head<span class="token punctuation">)</span>

                    byte_needed <span class="token operator">=</span> data_size
                    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token operator">&lt;</span> byte_needed <span class="token keyword">and</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
                        d <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span>byte_needed <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token keyword">not</span> d<span class="token punctuation">:</span> <span class="token keyword">break</span>
                        body <span class="token operator">+=</span> d

                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token operator">==</span> byte_needed<span class="token punctuation">:</span>
                        proto_no<span class="token punctuation">,</span> packet_id<span class="token punctuation">,</span> proto_buf <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>decode_packet_body<span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> body<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> proto_no <span class="token operator">==</span> <span class="token number">0x1</span><span class="token punctuation">:</span>
                            self<span class="token punctuation">.</span>handle_login_data<span class="token punctuation">(</span>proto_buf<span class="token punctuation">)</span>
                        
                        <span class="token keyword">elif</span> proto_no <span class="token operator">&gt;</span> <span class="token number">0x100</span><span class="token punctuation">:</span>
                            proto_data <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>process_packet<span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> proto_no<span class="token punctuation">,</span> packet_id<span class="token punctuation">,</span> proto_buf<span class="token punctuation">)</span>
                            self<span class="token punctuation">.</span>proto_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>proto_no<span class="token punctuation">,</span> proto_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">if</span> <span class="token keyword">not</span> proto_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                                data <span class="token operator">=</span> proto_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span>

                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">&quot;Incomplete packet body received&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># logger.warning(f&quot;Incomplete packet head received: {len(head)}&quot;)</span>
                    <span class="token keyword">pass</span>
            <span class="token keyword">except</span> ConnectionResetError<span class="token punctuation">:</span>
                <span class="token comment"># logger.error(f'robot receive ConnectionResetError error: {traceback.format_exc()}')</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>CancelledError<span class="token punctuation">:</span>
                <span class="token comment"># logger.error(f'robot receive asyncio.CancelledError error: {traceback.format_exc()}')</span>
                <span class="token comment"># await self.stop()</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
                <span class="token comment"># logger.error(f'robot receive asyncio.TimeoutError error : {traceback.format_exc()}')</span>
                <span class="token keyword">break</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                <span class="token comment"># logger.error(f'robot {self.device_id} receive error: {traceback.format_exc()}')</span>
                <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">ping</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token keyword">while</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
            <span class="token comment"># logger.info(f'time_since_last_ping: {datetime.datetime.now()}')</span>
            current_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
            time_since_last_ping <span class="token operator">=</span> <span class="token punctuation">(</span>current_time <span class="token operator">-</span> self<span class="token punctuation">.</span>last_ping_time<span class="token punctuation">)</span><span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> time_since_last_ping <span class="token operator">&gt;</span> HEART_BEAT_INTERVAL<span class="token punctuation">:</span>
                <span class="token comment"># logger.info(f'proto robot {self.device_id} ping, {self.last_ping_time}, {time_since_last_ping}')</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token builtin">buffer</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>proto_buf_encode<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ping_req<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'lastAck'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                    package_buffer <span class="token operator">=</span> self<span class="token punctuation">.</span>proto_helper<span class="token punctuation">.</span>encode_package<span class="token punctuation">(</span>Opcode<span class="token punctuation">.</span>Ping<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">buffer</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>package_buffer<span class="token punctuation">)</span>
                    <span class="token keyword">await</span> self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>drain<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>last_ping_time <span class="token operator">=</span> current_time
                <span class="token keyword">except</span> ConnectionRefusedError<span class="token punctuation">:</span>
                    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'connection refused.'</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
                    <span class="token comment"># 断开连接了 TODO: 销毁或者重连</span>
                    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'robot </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>device_id<span class="token punctuation">}</span></span><span class="token string"> host not reachable'</span></span><span class="token punctuation">)</span>
                    <span class="token comment"># self.destory()</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'ping exception: </span><span class="token interpolation"><span class="token punctuation">{</span>traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
                <span class="token keyword">finally</span><span class="token punctuation">:</span>
                    <span class="token comment"># logger.info('proto robot ping finally')</span>
                    <span class="token keyword">pass</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">stop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>writer<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>writer <span class="token operator">=</span> <span class="token boolean">None</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'robot </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>device_id<span class="token punctuation">}</span></span><span class="token string"> stop '</span></span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do_task</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">call_task_method</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>


</code></pre></div><h2 id="局限"><a href="#局限" class="header-anchor">#</a> 局限</h2> <p>同时创建超过1000个机器人时，有可能会出错：怀疑是fast_login时，http请求过多导致。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-blog/python/subprocess.html" class="prev">
        subprocess
      </a></span> <span class="next"><a href="/vuepress-blog/前端笔记/crossdomain.html">
        【vue】跨域解决方案之proxyTable
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-blog/assets/js/app.c8cd4592.js" defer></script><script src="/vuepress-blog/assets/js/2.b6e7c728.js" defer></script><script src="/vuepress-blog/assets/js/17.05758c46.js" defer></script>
  </body>
</html>
