<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>跨域 | 林晴的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="林晴的个人博客">
    <meta name="author" content="林晴">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.a53365af.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.74722c29.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.b6e7c728.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/19.d3278b1b.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.dcccb3a7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.83eff8f6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.7fa7278c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/13.fe79309d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.209bdc65.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.2361e72a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.4e641df4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.f3180cb7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.9029c90f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.d3bd6217.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.f4b8b73f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.fe3b92fb.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.d733c2e7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.27857469.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.475956e7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.0fa5abb8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.ab784b99.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.03e658c0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.09972edc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.01ff1db0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.56c918da.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.0790746d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.48d43c35.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.6a70a49e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.d5f77e8e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.f5c8e745.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.b80266b8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.b2e4517b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.dec834b8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.6f94c648.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.600bc016.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.d84fc58f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.90f7891a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.5bbded7f.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.a53365af.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">林晴的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小米商城</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue3</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>knowledge</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/knowledge/promise.html" class="sidebar-link">promise</a></li><li><a href="/vuepress-blog/knowledge/事件循环机制.html" class="sidebar-link">事件循环机制</a></li><li><a href="/vuepress-blog/knowledge/会话状态.html" class="sidebar-link">cookie</a></li><li><a href="/vuepress-blog/knowledge/模块加载.html" class="sidebar-link">模块加载</a></li><li><a href="/vuepress-blog/knowledge/跨域.html" class="active sidebar-link">跨域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog/knowledge/跨域.html#同源策略" class="sidebar-link">同源策略</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/knowledge/跨域.html#常见的跨域场景" class="sidebar-link">常见的跨域场景</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/knowledge/跨域.html#跨域的解决方法" class="sidebar-link">跨域的解决方法</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>daily</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大前端2021</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实践</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>部署</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h2> <p>同源策略是一种约定，是浏览器最核心也是最基本的安全功能。同源即“同协议，同域名，同端口”，集市两个不同域名指向同一 ip 也非同源，域名与对应 ip 也非同源。</p> <p>同源策略限制的几种行为：</p> <ol><li>cookie，localStorage 和 indexDB 等无法读取</li> <li>DOM 和 js 对象无法获得</li> <li>Ajax 请求不能发送</li></ol> <p>跨域中的请求是能发出去，并且服务器也有响应的，但是不能获得返回的数据，会被浏览器拦截，所以提交表单可以（因为没有获得返回数据），但是 Ajax 请求不行。</p> <p>有三个标签可以跨域加载资源：** img **, ** src **, ** lingk **</p> <h2 id="常见的跨域场景"><a href="#常见的跨域场景" class="header-anchor">#</a> 常见的跨域场景</h2> <table><thead><tr><th>URL</th> <th>说明</th> <th>是否允许通信</th></tr></thead> <tbody><tr><td>http://www.a.com/a.js<br>http://www.a.com/b.js</td> <td>同一域名，不同文件</td> <td>允许</td></tr> <tr><td>http://www.a.com/a.js<br>http://www.a.com:8000/b.js</td> <td>同域名，不同端口</td> <td>不允许</td></tr> <tr><td>http://www.a.com/a.js<br>https://www.a.com/b.js</td> <td>同域名，不同协议</td> <td>不允许</td></tr> <tr><td>http://www.a.com/a.js<br>http://127.0.0.1/b.js</td> <td>域名与对应 ip</td> <td>不允许</td></tr> <tr><td>http://www.a.com/a.js<br>http://x.a.com/b.js<br>http://a.com/c.js</td> <td>主域名相同，子域不同</td> <td>不允许</td></tr> <tr><td>http://www.a.com/a.js<br>http://www.b.com/b.js<br></td> <td>域名不同</td> <td>不允许</td></tr></tbody></table> <h2 id="跨域的解决方法"><a href="#跨域的解决方法" class="header-anchor">#</a> 跨域的解决方法</h2> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> jsonp</h3> <p>原理：某些 html 标签可以从不同域名下加载静态资源文件，而且是被浏览器允许的，所以可以基于此来进行跨域请求资源.通过动态创建一个 script 标签，src 指向目标服务器，并携带一个回调函数参数，该回调将请求返回值作为参数，然后后端将返回值包含在回调中，前端拿到回调直接执行。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://www.a.com/login?username=linqing&amp;callback=callback&quot;</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> callback<span class="token punctuation">,</span> username <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>callback<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>username<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h4> <ol><li>只能执行 get 请求。</li> <li>回调函数需要前后端协商好。</li></ol> <h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <p>跨域资源共享（CORS）是一种基于 HTTP 头机制，该机制通过允许服务器标示除了它自己以外的其他 origin（域，协议和端口），这样浏览器跨域访问这些资源。</p> <p>在 CORS 中将请求分为简单请求和复杂请求。</p> <p>“简单请求”不会触发 CORS 预检骑牛。满足下述所有条件的可以视为“简单请求”：</p> <ol><li>使用下列方法之一：
<ul><li>GET</li> <li>HEAD</li> <li>POST</li></ul></li> <li>人为设置以下集合外的请求头：
<ul><li>Accept</li> <li>Accept-Language</li> <li>Content-Language</li> <li>Content-Type</li> <li>DPR</li> <li>Downlink</li> <li>Save-Data</li> <li>Viewport-Width</li> <li>Width</li></ul></li> <li>Content-Type 的值仅限于下列三者之一：
<ul><li>text/plain</li> <li>multipart/form-data</li> <li>application/x-www-form-urlencoded</li></ul></li> <li>请求中的任意 XMLHttpRequestUpload 对象均没有注册任何事件监听器；XMLHttpRequestUpload 对象可以使用 XMLHttpRequest.upload 属性访问。</li> <li>请求中没有使用 ReadableStream 对象。</li></ol> <p>除了“简单请求”以外的都是复杂请求，会触发预检（options）请求。</p> <p>CORS 仅需要服务器进行配置。</p> <h4 id="node-中的-cors-解决方案"><a href="#node-中的-cors-解决方案" class="header-anchor">#</a> Node 中的 CORS 解决方案</h4> <ol><li>原生方式</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Credentials&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Request-Method&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PUT,POST,GET,DELETE,OPTIONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
    <span class="token string">&quot;Access-Control-Allow-Headers&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Origin, X-Requested-With, Content-Type, Accept, cc&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>koa-cors</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-cors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="关于-cors-中的-cookie-问题"><a href="#关于-cors-中的-cookie-问题" class="header-anchor">#</a> 关于 cors 中的 cookie 问题</h4> <p>想要传递 cookie 需要满足 3 个条件</p> <ol><li>web 请求设置 withCredentials</li> <li>Access-Control-Allow-Credentials 为 true</li> <li>Access-Control-Allow-Origin 为非</li></ol> <h3 id="node-正向代理"><a href="#node-正向代理" class="header-anchor">#</a> Node 正向代理</h3> <p>在 webpack 中配置 proxy 来获得接口代理的能力。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// vue.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token comment">//使用npm run serve启动的服务器地址</span>
    port<span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span> <span class="token comment">//监听的端口号，默认8080</span>
    proxy<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 键 需要与 axios的baseURL一致（完全匹配）</span>
      <span class="token string">&quot;/api&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        target<span class="token operator">:</span> <span class="token string">&quot;www.test.com&quot;</span><span class="token punctuation">,</span> <span class="token comment">//需要访问的跨域地址</span>
        changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//跨域要开启</span>
        pathRewrite<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;^/api&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>前端代理可以这样理解：前端发送 ajax 请求时，是先向本地开启的虚拟 nodejs 服务器 www.localhost.com:8080 去发送请求，再由这个虚拟服务器向上面的 target 服务器发送请求（服务器向服务器发送请求没有同源限制），虚拟服务器收到响应后再转发给前端。</p> <h3 id="nginx-反向代理"><a href="#nginx-反向代理" class="header-anchor">#</a> Nginx 反向代理</h3> <h3 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h3> <h3 id="window-postmessage"><a href="#window-postmessage" class="header-anchor">#</a> Window.postMessage</h3> <h3 id="document-domain-iframe"><a href="#document-domain-iframe" class="header-anchor">#</a> document.domain + Iframe</h3> <h3 id="window-location-hash-iframe"><a href="#window-location-hash-iframe" class="header-anchor">#</a> window.location.hash + Iframe</h3> <h3 id="window-name-iframe"><a href="#window-name-iframe" class="header-anchor">#</a> window.name + Iframe</h3> <h3 id="浏览器开启跨域"><a href="#浏览器开启跨域" class="header-anchor">#</a> 浏览器开启跨域</h3></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-blog/knowledge/模块加载.html" class="prev">
        模块加载
      </a></span> <span class="next"><a href="/vuepress-blog/javascript专题/你不知道的js.html">
        你不知道的js
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-blog/assets/js/app.74722c29.js" defer></script><script src="/vuepress-blog/assets/js/2.b6e7c728.js" defer></script><script src="/vuepress-blog/assets/js/19.d3278b1b.js" defer></script>
  </body>
</html>
